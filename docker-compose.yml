version: "3.9"

services:
  mediamtx:
    image: bluenviron/mediamtx:latest
    container_name: mediamtx
    ports:
      - "8554:8554"       # RTSP
      - "8888:8888"       # Web UI
      - "8889:8889"       # WebRTC HTTP signaling
      - "8189:8189/udp"   # WebRTC ICE/UDP
    volumes:
      - ./mediamtx.yml:/mediamtx.yml
    command: ["/mediamtx.yml"]
    restart: unless-stopped

  ffmpeg-hls:
    image: linuxserver/ffmpeg:latest
    container_name: ffmpeg-hls
    depends_on:
      - mediamtx
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
    restart: unless-stopped

    command: >
      -re
      -fflags nobuffer
      -i ${HLS_INPUT}
      -c copy
      -f rtsp ${RTSP_OUTPUT}