version: "3.9"

services:
  mediamtx:
    image: bluenviron/mediamtx:latest
    container_name: mediamtx
    ports:
      - "8554:8554"       # RTSP
      - "8888:8888"       # Web UI
      - "8889:8889"       # WebRTC HTTP signaling
      - "8189:8189/udp"   # WebRTC ICE/UDP
    volumes:
      - ./mediamtx.yml:/mediamtx.yml
    command: ["/mediamtx.yml"]
    restart: unless-stopped

  ffmpeg-hls:
    image: linuxserver/ffmpeg:latest
    container_name: ffmpeg-hls
    depends_on:
      - mediamtx
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
    restart: unless-stopped

    command: >
      -re
      -fflags nobuffer
      -i ${STREAM_SOURCE_HLS_URL}
      -c copy
      -f rtsp ${STREAM_RELAY_RTSP_URL}

  python-detector:
    build:
      context: ./python-detector
      dockerfile: Dockerfile
    container_name: python-detector
    depends_on:
      - ffmpeg-hls
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
      - STREAM_RELAY_RTSP_URL=${STREAM_RELAY_RTSP_URL}
      - VEHICLE_DETECTOR_MODEL_PATH=${VEHICLE_DETECTOR_MODEL_PATH}
    volumes:
      - ./models:/app/models
    restart: unless-stopped